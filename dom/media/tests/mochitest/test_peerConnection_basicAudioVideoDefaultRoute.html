<!DOCTYPE HTML>
<html>
<head>
  <script type="application/javascript" src="pc.js"></script>
</head>
<body>
<pre id="test">
<script type="application/javascript">
  createHTML({
    bug: "796890",
    title: "Basic audio/video (separate) peer connection"
  });

function PC_BOTH_WAIT_FOR_ICE_FAILED(test) {
   var isFail = (f, reason, msg) =>
     f().then(() => { throw new Error(msg + " must fail"); },
              e => is(e.message, reason, msg + " must fail with: " + e.message));

   return Promise.all([
     isFail(() => waitForIceConnected(test, test.pcLocal), "ICE failed", "Local ICE"),
     isFail(() => waitForIceConnected(test, test.pcRemote), "ICE failed", "Remote ICE")
   ])

   .then(() => ok(true, "ICE on both sides must fail."));
}

function PC_LOCAL_NO_HOST_CANDIDATES(test) {
  test.pcLocal._pc.addEventListener("icecandidate", function(e) {
    if (e.candidate) {
      is(-1, candidate.indexOf("host"),
       "No host candidates: " + JSON.stringify(can));
    }
  });
}


  runNetworkTest(function (options) {
     SpecialPowers.pushPrefEnv({
    'set': [
      ['media.peerconnection.ice.default_address_only', true]
    ]
  }, function() {
    var test = new PeerConnectionTest(options);
    test.setMediaConstraints([{audio: true}, {video: true}],
      [{audio: true}, {video: true}]);
    test.chain.insertAfter("PC_LOCAL_SETUP_ICE_HANDLER", PC_LOCAL_NO_HOST_CANDIDATES);
    test.chain.replace("PC_LOCAL_WAIT_FOR_ICE_CONNECTED", PC_BOTH_WAIT_FOR_ICE_FAILED);
    test.chain.removeAfter("PC_BOTH_WAIT_FOR_ICE_FAILED");
    test.run();
   }
       );
});

</script>
</pre>
</body>
</html>
